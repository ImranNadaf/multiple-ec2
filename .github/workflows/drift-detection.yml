name: Terraform Drift Detection

on:
  workflow_call:
    inputs:
      tf_working_dir:
        required: false
        type: string
        default: "."
      aws_region:
        required: false
        type: string
        default: "us-east-2"

jobs:
  drift-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false # Required to capture exact exit codes

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ inputs.aws_region }}

      - name: Terraform Init
        working-directory: ${{ inputs.tf_working_dir }}
        run: terraform init -input=false

      - name: Terraform Plan (Drift Detection)
        id: plan
        working-directory: ${{ inputs.tf_working_dir }}
        run: |
          set +e
          # Generate plan and capture detailed exit code
          terraform plan -input=false -no-color -detailed-exitcode > plan.txt
          exit_code=$?
          
          # Pass the exit code to GitHub Actions outputs
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          
          echo "Terraform plan finished with exit code: $exit_code"
          exit 0

      - name: Upload plan output
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: ${{ inputs.tf_working_dir }}/plan.txt

      - name: Create GitHub Issue on Drift
        if: steps.plan.outputs.exit_code == '2'
        uses: actions/github-script@v7
        with:
          script: |
            const title = "⚠️ Terraform Drift Detected";
            const body = `Terraform plan has detected drift in the infrastructure.
            
            - **Repo:** ${context.repo.owner}/${context.repo.repo}
            - **Workflow:** ${context.workflow}
            - **Run ID:** [${context.runId}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            Please review the attached plan artifact for details.`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body
            });

      - name: Final Status Check
        working-directory: ${{ inputs.tf_working_dir }}
        run: |
          if [ "${{ steps.plan.outputs.exit_code }}" == "2" ]; then
            echo "DRIFT DETECTED: Plan shows changes."
            exit 1
          elif [ "${{ steps.plan.outputs.exit_code }}" == "0" ]; then
            echo "SUCCESS: No drift detected."
            exit 0
          else
            echo "ERROR: Terraform plan failed with exit code ${{ steps.plan.outputs.exit_code }}."
            exit 1
          fi